(()=>{"use strict";async function t(t,e={},n={}){const{nonce:o=window.dkpdf_ajax?.nonce,method:a="POST"}=n,d=new FormData;d.append("action",t),d.append("nonce",o),Object.keys(e).forEach(t=>{e[t],File,d.append(t,e[t])});const s={method:a,body:d,credentials:"same-origin"};!1===n.processData&&(delete s.body,s.body=e);try{const t=await fetch(window.dkpdf_ajax?.ajax_url||"/wp-admin/admin-ajax.php",s);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(t){throw console.error("AJAX request failed:",t),t}}function e(t,e=200){t.style.opacity="1";let n=null;const o=a=>{n||(n=a);const d=a-n,s=Math.max(1-d/e,0);t.style.opacity=s,d<e?requestAnimationFrame(o):t.style.display="none"};requestAnimationFrame(o)}function n(t){t.style.display=""}function o(t){t.style.display="none"}function a(t){for(;t.firstChild;)t.removeChild(t.firstChild)}class d{constructor(){this.modal=null,this.fonts=[],this.selectedFile=null,this.init()}init(){this.bindEvents(),this.createModal()}bindEvents(){document.addEventListener("click",t=>{t.target.closest("#dkpdf-manage-fonts")&&(t.preventDefault(),this.openModal())}),document.addEventListener("click",t=>{t.target.closest(".dkpdf-modal-close")&&(t.preventDefault(),this.closeModal())}),document.addEventListener("click",t=>{t.target.matches(".dkpdf-modal-overlay")&&this.closeModal()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.modal&&null!==this.modal.offsetParent&&this.closeModal()}),document.addEventListener("click",t=>{t.target.closest("#dkpdf-select-file-btn")&&(t.preventDefault(),document.getElementById("dkpdf-font-file-input").click())}),document.addEventListener("change",t=>{if(t.target.matches("#dkpdf-font-file-input")){const e=t.target.files[0];if(e){this.selectedFile=e;const t=document.getElementById("dkpdf-selected-filename");t&&(t.textContent=e.name,t.style.display="inline");const n=document.getElementById("dkpdf-select-file-btn"),o=document.getElementById("dkpdf-upload-font-btn");n&&(n.style.display="none"),o&&(o.style.display="inline-block")}}}),document.addEventListener("change",t=>{if(t.target.matches("#dkpdf-family-selector")){const e=document.getElementById("dkpdf-new-family-row");"__new__"===t.target.value?e.style.display="block":e.style.display="none"}}),document.addEventListener("click",t=>{t.target.closest("#dkpdf-upload-font-btn")&&(t.preventDefault(),this.selectedFile&&this.uploadFont(this.selectedFile))}),document.addEventListener("click",t=>{const e=t.target.closest(".dkpdf-delete-font");if(e){t.preventDefault();const n=e.dataset.fontKey,o=e.dataset.fontType;this.confirmDelete(n,o)}})}createModal(){const t=window.dkpdf_ajax?.i18n||{},e=`\n\t\t\t<div class="dkpdf-modal-overlay" style="display:none;">\n\t\t\t\t<div class="dkpdf-modal">\n\t\t\t\t\t<div class="dkpdf-modal-header">\n\t\t\t\t\t\t<h2>${t.manage_fonts||"Manage Fonts"}</h2>\n\t\t\t\t\t\t<button class="dkpdf-modal-close" aria-label="${t.close||"Close"}">&times;</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="dkpdf-modal-body">\n\t\t\t\t\t\t<div class="dkpdf-upload-form">\n\t\t\t\t\t\t\t<div class="dkpdf-form-row">\n\t\t\t\t\t\t\t\t<label for="dkpdf-family-selector">${t.font_family||"Font Family"} <span style="color: #d63638;">*</span></label>\n\t\t\t\t\t\t\t\t<select id="dkpdf-family-selector" class="regular-text" required>\n\t\t\t\t\t\t\t\t\t<option value="">${t.select_family||"-- Select Font Family --"}</option>\n\t\t\t\t\t\t\t\t\t<option value="__new__">${t.create_new_family||"+ Create New Family"}</option>\n\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="dkpdf-form-row" id="dkpdf-new-family-row" style="display:none;">\n\t\t\t\t\t\t\t\t<label for="dkpdf-new-family-name">${t.new_family_name||"New Family Name"} <span style="color: #d63638;">*</span></label>\n\t\t\t\t\t\t\t\t<input type="text" id="dkpdf-new-family-name" class="regular-text" placeholder="${t.enter_family_name||"e.g., Montserrat"}">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="dkpdf-form-row">\n\t\t\t\t\t\t\t\t<label for="dkpdf-variant-type">${t.variant_type||"Variant Type"} <span style="color: #d63638;">*</span></label>\n\t\t\t\t\t\t\t\t<select id="dkpdf-variant-type" class="regular-text" required>\n\t\t\t\t\t\t\t\t\t<option value="">${t.select_variant||"-- Select Variant --"}</option>\n\t\t\t\t\t\t\t\t\t<option value="R">${t.regular||"Regular"}</option>\n\t\t\t\t\t\t\t\t\t<option value="B">${t.bold||"Bold"}</option>\n\t\t\t\t\t\t\t\t\t<option value="I">${t.italic||"Italic"}</option>\n\t\t\t\t\t\t\t\t\t<option value="BI">${t.bold_italic||"Bold Italic"}</option>\n\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="dkpdf-form-row">\n\t\t\t\t\t\t\t\t<div class="dkpdf-file-selection">\n\t\t\t\t\t\t\t\t\t<button type="button" id="dkpdf-select-file-btn" class="button">\n\t\t\t\t\t\t\t\t\t\t${t.select_file||"Select File"}\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t<button type="button" id="dkpdf-upload-font-btn" class="button button-primary" style="display:none;">\n\t\t\t\t\t\t\t\t\t\t${t.upload_font||"Upload Font"}\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t<span id="dkpdf-selected-filename" style="display:none; margin-left: 10px; color: #666;"></span>\n\t\t\t\t\t\t\t\t\t<input type="file" id="dkpdf-font-file-input" accept=".ttf" style="display:none;">\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="dkpdf-modal-message"></div>\n\t\t\t\t\t\t<div class="dkpdf-fonts-list-wrapper">\n\t\t\t\t\t\t\t<div class="dkpdf-loading">${t.loading||"Loading"}...</div>\n\t\t\t\t\t\t\t<ul class="dkpdf-fonts-list"></ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;document.querySelector(".dkpdf-modal-overlay")||document.body.insertAdjacentHTML("beforeend",e),this.modal=document.querySelector(".dkpdf-modal-overlay")}async openModal(){!function(t,e=200){t.style.display="flex",t.style.opacity="0";let n=null;const o=a=>{n||(n=a);const d=a-n,s=Math.min(d/e,1);t.style.opacity=s,d<e&&requestAnimationFrame(o)};requestAnimationFrame(o)}(this.modal,200),await this.loadFonts(),this.populateFamilySelector()}closeModal(){e(this.modal,200),this.clearMessage()}async loadFonts(){const e=document.querySelector(".dkpdf-loading"),d=document.querySelector(".dkpdf-fonts-list");n(e),a(d);try{const n=await t("dkpdf_list_fonts");o(e),n.success&&n.data.fonts?(this.fonts=n.data.fonts,this.renderFontsList(n.data.fonts)):this.showMessage(window.dkpdf_ajax?.i18n?.error_loading_fonts||"Failed to load fonts.","error")}catch(t){o(e),this.showMessage(window.dkpdf_ajax?.i18n?.error_loading_fonts||"Failed to load fonts.","error")}}renderFontsList(t){const e=document.querySelector(".dkpdf-fonts-list"),n=window.dkpdf_ajax?.i18n||{};a(e),0!==t.length?t.forEach(t=>{let o="";t.selected&&(o+=`<span class="dkpdf-badge dkpdf-badge-active">${n.active||"Active"}</span>`),t.category&&(o+=`<span class="dkpdf-badge dkpdf-badge-category">${t.category}</span>`),o+=`<span class="dkpdf-badge dkpdf-badge-${t.type}">${"core"===t.type?n.core||"Core":n.custom||"Custom"}</span>`;let a="";if("custom"===t.type&&t.variants){const e={R:"Regular",B:"Bold",I:"Italic",BI:"Bold Italic"};a='<div class="dkpdf-font-variants">',["R","B","I","BI"].forEach(n=>{const o=t.variants[n]&&t.variants[n].exists,d=o?"✓":"✗";a+=`<span class="dkpdf-variant ${o?"dkpdf-variant-exists":"dkpdf-variant-missing"}" title="${e[n]}">${n} ${d}</span>`}),a+="</div>"}const d=t.selected?`<button class="button dkpdf-delete-font" disabled data-font-key="${t.key}" data-font-type="${t.type}" title="${n.cannot_delete_active||"Cannot delete the currently selected font"}">${n.delete||"Delete"}</button>`:`<button class="button dkpdf-delete-font" data-font-key="${t.key}" data-font-type="${t.type}">${n.delete||"Delete"}</button>`,s=`\n\t\t\t\t<li class="dkpdf-font-item ${t.selected?"dkpdf-font-selected":""}">\n\t\t\t\t\t<div class="dkpdf-font-info">\n\t\t\t\t\t\t<span class="dkpdf-font-name">${t.family_name||t.name}</span>\n\t\t\t\t\t\t${a}\n\t\t\t\t\t\t<div class="dkpdf-font-badges">${o}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="dkpdf-font-actions">\n\t\t\t\t\t\t${d}\n\t\t\t\t\t</div>\n\t\t\t\t</li>\n\t\t\t`;e.insertAdjacentHTML("beforeend",s)}):e.innerHTML=`<li class="dkpdf-no-fonts">${n.no_fonts||"No fonts available."}</li>`}async uploadFont(e){const n=window.dkpdf_ajax?.i18n||{};if(!e.name.toLowerCase().endsWith(".ttf"))return void this.showMessage(n.only_ttf_files||"Only TTF font files are supported.","error");const o=document.getElementById("dkpdf-family-selector"),a=o?.value||"";let d="";if(!a)return void this.showMessage(n.select_family_required||"Please select a font family or create a new one.","error");if("__new__"===a){const t=document.getElementById("dkpdf-new-family-name");if(d=t?.value||"",!d.trim())return void this.showMessage(n.family_name_required||"Family name is required.","error")}else d=a;const s=document.getElementById("dkpdf-variant-type"),l=s?.value||"";if(!l)return void this.showMessage(n.variant_required||"Variant type is required.","error");const i=document.getElementById("dkpdf-upload-font-btn"),c=i.textContent;i.disabled=!0,i.textContent=n.uploading||"Uploading...",this.clearMessage();try{const o=await t("dkpdf_upload_font",{font_file:e,family_name:d,variant:l});o.success?(this.showMessage(o.data.message,"success"),await this.loadFonts(),this.populateFamilySelector(),this.resetUploadForm(),this.refreshFontSelector()):(i.disabled=!1,i.textContent=c,this.showMessage(o.data.message||n.upload_failed||"Failed to upload font.","error"))}catch(t){i.disabled=!1,i.textContent=c,this.showMessage(n.upload_failed||"Failed to upload font.","error")}}resetUploadForm(){const t=window.dkpdf_ajax?.i18n||{};this.selectedFile=null;const e=document.getElementById("dkpdf-family-selector");e&&(e.value="");const n=document.getElementById("dkpdf-new-family-name");n&&(n.value="");const o=document.getElementById("dkpdf-new-family-row");o&&(o.style.display="none");const a=document.getElementById("dkpdf-variant-type");a&&(a.value="");const d=document.getElementById("dkpdf-font-file-input");d&&(d.value="");const s=document.getElementById("dkpdf-selected-filename");s&&(s.textContent="",s.style.display="none");const l=document.getElementById("dkpdf-select-file-btn"),i=document.getElementById("dkpdf-upload-font-btn");l&&(l.style.display="inline-block",l.disabled=!1),i&&(i.style.display="none",i.disabled=!1,i.textContent=t.upload_font||"Upload Font")}confirmDelete(t,e){const n=window.dkpdf_ajax?.i18n||{},o="core"===e?(n.confirm_delete_core||'Are you sure you want to delete the core font "%s"?').replace("%s",t):(n.confirm_delete_custom||'Are you sure you want to delete the custom font family "%s"?').replace("%s",t);confirm(o)&&this.deleteFont(t)}async deleteFont(e){const n=window.dkpdf_ajax?.i18n||{};this.clearMessage();try{const o=await t("dkpdf_delete_font",{font_key:e});o.success?(this.showMessage(o.data.message,"success"),this.loadFonts(),this.refreshFontSelector()):this.showMessage(o.data.message||n.delete_failed||"Failed to delete font.","error")}catch(t){this.showMessage(n.delete_failed||"Failed to delete font.","error")}}populateFamilySelector(){const t=document.getElementById("dkpdf-family-selector");if(!t)return;const e=t.querySelectorAll('option[value=""], option[value="__new__"]');if(t.innerHTML="",e.forEach(e=>t.appendChild(e)),this.fonts&&this.fonts.length>0){const e=this.fonts.filter(t=>"custom"===t.type);e.length>0&&e.forEach(e=>{const n=document.createElement("option");n.value=e.family_name,n.textContent=e.family_name,t.insertBefore(n,t.querySelector('option[value="__new__"]'))})}}extractFamilyName(t){let e=t.replace(/\.ttf$/i,"");const n=[/-BoldItalic$/i,/-BoldOblique$/i,/-Bold$/i,/-Italic$/i,/-Oblique$/i,/-Regular$/i,/-BI$/i,/-B$/i,/-I$/i,/-R$/i];for(const t of n)e=e.replace(t,"");return e}formatFontName(t){let e=t.replace(/-/g," ");return e=e.replace(/([a-z])([A-Z])/g,"$1 $2"),e}async refreshFontSelector(){const e=document.getElementById("dkpdf_default_font");if(!e)return;const n=e.value;try{const o=await t("dkpdf_list_fonts");if(o.success&&o.data.fonts){const t=o.data.fonts;e.disabled=!1,a(e),t.forEach(t=>{if(t.complete||"core"===t.type){const o=document.createElement("option");o.value=t.key||t.name,o.textContent=this.formatFontName(t.family_name||t.name),"core"===t.type&&(o.textContent+=" (Core)"),(t.key&&t.key===n||t.name===n||t.selected)&&(o.selected=!0),e.appendChild(o)}});const d=e.nextElementSibling;if(d&&d.classList.contains("description")){const e=t.filter(t=>"core"===t.type).length,n=t.filter(t=>"custom"===t.type).length;d.textContent=`${e} core fonts, ${n} custom fonts available. Need more? See options below.`}}}catch(t){console.error("Failed to refresh font selector:",t)}}showMessage(t,o){const d=document.querySelector(".dkpdf-modal-message");d.innerHTML=`<div class="notice notice-${"error"===o?"error":"success"}"><p>${t}</p></div>`,n(d),"success"===o&&setTimeout(()=>{e(d,300),setTimeout(()=>a(d),300)},5e3)}clearMessage(){const t=document.querySelector(".dkpdf-modal-message");a(t),o(t)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new d}):new d})();