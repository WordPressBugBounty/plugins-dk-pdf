(()=>{"use strict";async function e(e,t={},n={}){const{nonce:o=window.dkpdf_ajax?.nonce,method:s="POST"}=n,l=new FormData;l.append("action",e),l.append("nonce",o),Object.keys(t).forEach(e=>{t[e],File,l.append(e,t[e])});const r={method:s,body:l,credentials:"same-origin"};!1===n.processData&&(delete r.body,r.body=t);try{const e=await fetch(window.dkpdf_ajax?.ajax_url||"/wp-admin/admin-ajax.php",r);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw console.error("AJAX request failed:",e),e}}class t{constructor(){this.init()}init(){this.initColorPicker(),this.initMediaUploader(),this.initNavigation(),this.initSelect2(),this.initFontDownloader()}initColorPicker(){document.querySelectorAll(".colorpicker").forEach(e=>{e.style.display="none","undefined"!=typeof jQuery&&jQuery.fn.farbtastic&&jQuery(e).farbtastic(jQuery(e).closest(".color-picker").find(".color"))}),document.querySelectorAll(".color").forEach(e=>{e.addEventListener("click",function(){this.closest(".color-picker").querySelector(".colorpicker").style.display="block"})}),document.addEventListener("mousedown",e=>{e.target.closest(".color-picker")||document.querySelectorAll(".colorpicker").forEach(e=>{"block"===e.style.display&&(e.style.display="none")})})}initMediaUploader(){let e;document.querySelectorAll(".image_upload_button").forEach(t=>{t.addEventListener("click",function(t){t.preventDefault(),(t=>{const n=t.id,o=n.replace("_button",""),s=n.replace("_button","_preview");e||(e=wp.media.frames.file_frame=wp.media({title:t.dataset.uploaderTitle,button:{text:t.dataset.uploaderButtonText},multiple:!1}),e.on("select",function(){const t=e.state().get("selection").first().toJSON();document.getElementById(o).value=t.id;{const e=document.getElementById(s);e&&(e.src=t.sizes.thumbnail.url)}})),e.open()})(this)})}),document.querySelectorAll(".image_delete_button").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.closest("td").querySelector(".image_data_field");t&&(t.value="");const n=document.querySelector(".image_preview");n&&n.remove()})})}initNavigation(){const e=document.querySelector("ul#settings-sections.subsubsub");e&&(e.querySelectorAll("a").forEach((e,t)=>{const n=e.getAttribute("href").replace("#",""),o=e.textContent;document.querySelectorAll("h3").forEach(e=>{e.textContent.includes(o)&&(e.setAttribute("id",n),e.classList.add("section-heading"))})}),document.querySelectorAll("#plugin_settings .subsubsub a.tab").forEach(e=>{e.addEventListener("click",function(e){if(e.preventDefault(),document.querySelectorAll(".subsubsub .current").forEach(e=>{e.classList.remove("current")}),this.classList.add("current"),this.classList.contains("all"))return void document.querySelectorAll("#plugin_settings h3, #plugin_settings form p, #plugin_settings table.form-table, p.submit").forEach(e=>{e.style.display=""});let t=this.getAttribute("href");t=t.replace("#",""),document.querySelectorAll("#plugin_settings h3, #plugin_settings form > p:not(.submit), #plugin_settings table").forEach(e=>{e.style.display="none"});const n=document.getElementById(t);if(n){n.style.display="";let e=n.nextElementSibling;for(;e&&!e.matches("h3.section-heading");)e.matches("p, table, table p")&&(e.style.display=""),e=e.nextElementSibling}})}))}initSelect2(){"undefined"!=typeof jQuery&&jQuery.fn.select2&&document.querySelectorAll(".dkpdf-select2-ajax").forEach(e=>{const t=e.dataset.postType,n=e.dataset.ajaxAction;t&&n?jQuery(e).select2({placeholder:"",width:"100%",minimumInputLength:0,dropdownAutoWidth:!0,ajax:{url:window.dkpdf_ajax?.ajax_url,dataType:"json",delay:250,data:function(e){return{q:e.term||"",post_type:t,action:n,nonce:window.dkpdf_ajax?.nonce}},processResults:function(e){return e.success&&e.data?{results:e.data}:{results:[]}},cache:!0}}):jQuery(e).select2({placeholder:"Select custom fields...",width:"100%"})})}initFontDownloader(){const t=document.getElementById("dkpdf-download-fonts");t&&t.addEventListener("click",async n=>{n.preventDefault();const o=document.getElementById("dkpdf-download-progress"),s=document.querySelector(".dkpdf-progress-fill"),l=document.querySelector(".dkpdf-progress-text"),r=document.getElementById("dkpdf-download-status");t.disabled=!0,t.textContent="Downloading...",o.style.display="block",r.innerHTML="";const a=setInterval(async()=>{try{const t=await e("dkpdf_download_progress");if(t.success){const e=t.data.progress;s.style.width=e+"%",l.textContent=e+"%",e>=100&&clearInterval(a)}}catch(e){console.error("Progress update failed:",e)}},500);try{const n=await e("dkpdf_download_fonts");if(clearInterval(a),n.success)s.style.width="100%",l.textContent="100%",setTimeout(()=>{t.parentElement.innerHTML='<p class="dkpdf-core-fonts-status"><span class="dashicons dashicons-yes-alt" style="color: #46b450; vertical-align: middle;"></span> Core fonts installed</p>',r.innerHTML='<p class="notice notice-success inline"><strong>Fonts downloaded successfully! Reloading page...</strong></p>',setTimeout(()=>{window.location.reload()},1e3)},500);else{t.disabled=!1,t.textContent="Download Fonts",o.style.display="none",s.style.width="0%",l.textContent="0%";const e=n.data?.message||"Unknown error";r.innerHTML='<p class="notice notice-error inline"><strong>Error:</strong> '+e+"</p>"}}catch(e){clearInterval(a),t.disabled=!1,t.textContent="Download Fonts",o.style.display="none",s.style.width="0%",l.textContent="0%",r.innerHTML='<p class="notice notice-error inline"><strong>Error:</strong> Failed to download fonts. Please try again.</p>'}})}async refreshFontSelector(){const t=document.getElementById("dkpdf_default_font");if(t)try{const n=await e("dkpdf_list_fonts");if(n.success&&n.data.fonts){const e=t.value;t.innerHTML="";const o=n.data.fonts;o.forEach(n=>{if(!n.complete)return;const o=document.createElement("option");o.value=n.key,o.textContent=n.family_name,"core"===n.type&&(o.textContent+=" (Core)"),(n.key===e||n.selected)&&(o.selected=!0),t.appendChild(o)});const s=t.nextElementSibling;if(s&&s.classList.contains("description")){const e=o.filter(e=>"core"===e.type).length,t=o.filter(e=>"custom"===e.type).length;s.textContent=`${e} core fonts, ${t} custom fonts available. Need more? See options below.`}}}catch(e){console.error("Failed to refresh font selector:",e)}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new t}):new t})();